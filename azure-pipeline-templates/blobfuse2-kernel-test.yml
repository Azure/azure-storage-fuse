parameters:
  - name: temp_dir
    type: string
  - name: mount_dir
    type: string    
  - name: idstring
    type: string
  - name: kversion
    type: string
  - name: container
    type: string

steps:    
  - template: 'mount.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}
      prefix: ${{ parameters.idstring }}
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount ${{ parameters.mount_dir }} --tmp-path=${{ parameters.temp_dir }} --container-name=${{ parameters.container }} --default-working-dir=$(WORK_DIR) 

  - script: |
      cd ${{ parameters.mount_dir }}
      wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ parameters.kversion }}.tar.xz  
    displayName: 'Get kernel tarfile'

  - script: |
      cd ${{ parameters.mount_dir }}
      tar -xvf ${{ parameters.mount_dir }}/linux-${{ parameters.kversion }}.tar.xz
    displayName: 'Untar kernel'

  - script: |
      cd ${{ parameters.mount_dir }}/linux-${{ parameters.kversion }}
      cp -v /boot/config-$(uname -r) .config
      make defconfig
      make
    displayName: 'Run MAKE on the kernel'

  - script: |
      cd ${{ parameters.mount_dir }}
      tar -zcvf linux-${{ parameters.kversion }}.tar.gz linux-${{ parameters.kversion }}
    displayName: 'Tar kernel'

  - script: |
      tail -n 200 blobfuse2-logs.txt
    displayName: 'View Logs'
    condition: failed()

  - script: |
      cd ${{ parameters.mount_dir }}
      rm -rf linux-${{ parameters.kversion }}
    displayName: 'Cleanup kernel'

  - template: 'cleanup.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}