# Data Consistency check across blobfuse different configuration files.
parameters:
  - name: config_file
    type: string
  - name: account_name
    type: string
  - name: account_type
    type: string
  - name: account_key
    type: string
  - name: verbose_log
    type: boolean
    default: false
  - name: idstring
    type: string
    default: 

steps:
  # Generate Data in the local filesystem, This step is only required once at the step
  - template: 'data.yml'
    parameters:
      generate_data: true
  # Test data consistency for various Config options.

  # Generate config file for file cache
  - script: |
      $(WORK_DIR)/blobfuse2 gen-test-config --config-file=$(WORK_DIR)/testdata/config/azure_key.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=${{ parameters.config_file }}
      cat ${{ parameters.config_file }}
    displayName: 'Create Config File for File Cache'
    env:
      NIGHTLY_STO_ACC_NAME: ${{ parameters.account_name }}
      NIGHTLY_STO_ACC_KEY: ${{ parameters.account_key }}
      ACCOUNT_TYPE: ${{ parameters.account_type }}
      VERBOSE_LOG: ${{ parameters.verbose_log }}
    continueOnError: false
  
  # Mount in File cache
  - template: 'mount.yml'
    parameters:
      prefix: ${{ parameters.idstring }}-filecache
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR) --file-cache-timeout=3200
  - template: 'data.yml'
    parameters:
      copy_data: true
      check_consistency: true
  
  # Mount in File cache with direct-io
  - template: 'mount.yml'
    parameters:
      prefix: ${{ parameters.idstring }}-filecache-directio
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR) --file-cache-timeout=3200 -o direct_io
  - template: 'data.yml'
    parameters:
      copy_data: true
      check_consistency: true

  # Generate Config file for block cache
  - script: |
      $(WORK_DIR)/blobfuse2 gen-test-config --config-file=$(WORK_DIR)/testdata/config/azure_key_bc.yaml --container-name=$(containerName) --temp-path=${{ parameters.temp_dir }} --output-file=${{ parameters.config_file }}
      cat ${{ parameters.config_file }}
    displayName: 'Create Config File for Block Cache'
    env:
      NIGHTLY_STO_ACC_NAME: ${{ parameters.account_name }}
      NIGHTLY_STO_ACC_KEY: ${{ parameters.account_key }}
      ACCOUNT_TYPE: ${{ parameters.account_type }}
      VERBOSE_LOG: ${{ parameters.verbose_log }}
 
  # Mount in Block Cache.
  - template: 'mount.yml'
    parameters:
      prefix: ${{ parameters.idstring }}
      ro_mount: true
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR)
  - template: 'data.yml'
    parameters:
      copy_data: true
      check_consistency: true

  # Mount in Block Cache direct-io
  - template: 'mount.yml'
    parameters:
      prefix: ${{ parameters.idstring }}
      ro_mount: true
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR) -o direct_io
  - template: 'data.yml'
    parameters:
      copy_data: true
      check_consistency: true

  # Mount in Block Cache read-only
  - template: 'mount.yml'
    parameters:
      prefix: ${{ parameters.idstring }}
      ro_mount: true
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR) -o ro
  - template: 'data.yml'
    parameters:
      copy_data: false
      check_consistency: true

  