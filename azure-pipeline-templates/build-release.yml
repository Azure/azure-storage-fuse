parameters:
  - name: work_dir
    type: string
  - name: root_dir
    type: string
  - name: unit_test
    type: boolean
    default: false
  - name: tags
    type: string
    default: "null"
  - name: container
    type: string

steps:
  # Installing Go tool
  - task: ShellScript@2
    inputs:
      scriptPath: "${{ parameters.work_dir }}/go_installer.sh"
      args: "${{ parameters.root_dir }}/"
    displayName: "Installing Go tools"

  # Installing Blobfuse2 Dependencies via go get
  - task: Go@0
    inputs:
      command: 'get'
      arguments: '-d'
      workingDirectory: ${{ parameters.work_dir }}
    displayName: "Installing Blobfuse2 Dependencies"

  # install fuse3 libfuse3-dev
  - script: |
      sudo apt-get update --fix-missing
      sudo apt-get install fuse3 libfuse3-dev -y
      fusermount -V
    displayName: 'Libfuse Setup'

  - script: |
      if [ ! -d "$(unsigned)" ]; then
        mkdir -p $(unsigned)
      fi
    displayName: 'Check and create output paths'
    
  # Build the binary  
  - script: |
      sudo go build -tags ${{ parameters.tags }} -o blobfuse2
    workingDirectory: ${{ parameters.work_dir }}
    displayName: 'Building Blobfuse2'
  
  # Verifying whether built binary is correct
  - script: |
      sudo chmod +x ./blobfuse2
      ./blobfuse2 --version
    workingDirectory: ${{ parameters.work_dir }}
    displayName: "Test Binary built"
    continueOnError: false

  - script: |
      ldd ./blobfuse2 | grep fuse
    workingDirectory: ${{ parameters.work_dir }}
    displayName: 'Check fuse version in binary'

  # Build the health-monitor binary
  - script: |
      chmod 755 build.sh
      ./build.sh health
    workingDirectory: ${{ parameters.work_dir }}
    displayName: "Building health-monitor binary"
    continueOnError: false
  
  # Verifying whether built binary is correct
  - script: |
      sudo chmod +x ./bfusemon
      ./bfusemon --version
    workingDirectory: ${{ parameters.work_dir }}
    displayName: "Test bfusemon binary built"
    continueOnError: false

  # Run Unit tests if parameters is true
  - ${{ if eq(parameters.unit_test, true) }}:
      - script: |
          cnfFile=$HOME/azuretest.json
          echo $cnfFile
          touch $cnfFile
          echo "{" > $cnfFile
          echo "\"block-acct\"": "\"$(AZTEST_BLOCK_ACC_NAME)\"", >> $cnfFile
          echo "\"adls-acct\"": "\"$(AZTEST_ADLS_ACC_NAME)\"", >> $cnfFile
          echo "\"block-cont\"": "\"${{ parameters.container }}\"", >> $cnfFile
          echo "\"adls-cont\"": "\"${{ parameters.container }}\"", >> $cnfFile
          echo "\"block-key\"": "\"$(AZTEST_BLOCK_KEY)\"", >> $cnfFile
          echo "\"adls-key\"": "\"$(AZTEST_ADLS_KEY)\"", >> $cnfFile
          echo "\"block-sas\"": "\"$(AZTEST_BLOCK_SAS)\"", >> $cnfFile
          echo "\"block-cont-sas-ubn-18\"": "\"$(AZTEST_BLOCK_CONT_SAS_UBN_18)\"", >> $cnfFile
          echo "\"block-cont-sas-ubn-20\"": "\"$(AZTEST_BLOCK_CONT_SAS_UBN_20)\"", >> $cnfFile
          echo "\"adls-sas\"": "\"$(AZTEST_ADLS_SAS)\"", >> $cnfFile
          echo "\"msi-appid\"": "\"$(AZTEST_APP_ID)\"", >> $cnfFile
          echo "\"msi-resid\"": "\"$(AZTEST_RES_ID)\"", >> $cnfFile
          echo "\"msi-objid\"": "\"$(AZTEST_OBJ_ID)\"", >> $cnfFile
          echo "\"skip-msi\"": "true", >> $cnfFile
          echo "\"skip-azcli\"": "true", >> $cnfFile
          echo "\"proxy-address\"": "\"\"" >> $cnfFile
          
          echo "}" >> $cnfFile
          cat $cnfFile
        displayName: "Create AzureTest Config"
        continueOnError: false
        workingDirectory: ${{ parameters.work_dir }}

      - task: Go@0
        inputs:
          command: 'test'
          arguments: '-v -timeout=2h ./... --tags=unittest,${{ parameters.tags }} -coverprofile utcover.cov'
          workingDirectory: ${{ parameters.work_dir }}
        displayName: "Unit tests"


