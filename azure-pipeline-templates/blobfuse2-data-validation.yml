parameters:
  - name: temp_dir
    type: string
  - name: mount_dir
    type: string    
  - name: idstring
    type: string
  - name: kversion
    type: string
  - name: config_file
    type: string   

steps:    
  - template: 'mount.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}
      prefix: ${{ parameters.idstring }}
      mountStep: 
        script: |
          $(WORK_DIR)/blobfuse2 mount ${{ parameters.mount_dir }} --config-file=${{ parameters.config_file }} --default-working-dir=$(WORK_DIR) 

  - script: |
      cd ${{ parameters.mount_dir }}
      wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ parameters.kversion }}.tar.xz  
    displayName: 'Get kernel tarfile'

  - script: |
      tar -xvf {{ parameters.mount_dir }}/linux-${{ parameters.kversion }}.tar.xz
    displayName: 'Untar kernel'

  - script: |
      cd {{ parameters.mount_dir }}/linux-${{ parameters.kversion }}
      make defconfig
      make
    displayName: 'Run MAKE on the kernel'

  - template: 'cleanup.yml'
    parameters:
      working_dir: $(WORK_DIR)
      mount_dir: ${{ parameters.mount_dir }}
      temp_dir: ${{ parameters.temp_dir }}