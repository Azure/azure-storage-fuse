# Blobfuse2 Nightly Build Pipeline

schedules:
  # Cron string < minute hour day-of-month month day-of-week>
  #             * means all, for example '*' in day of month means everyday
  # Run only on main branch
  # 'always' controls whether to run only if there is a change or not
  # Run this pipeline every 15:00 time
  - cron: '0 15 * * *'
    displayName: 'Daily midnight Blobfuse2 build'
    branches:
      include:
        - main

parameters:
  - name: base_test
    # Quick test or an exhaustive test
    displayName: 'Basic test'
    type: boolean
    default: true

  - name: exhaustive_test
    # Quick test or an exhaustive test
    displayName: 'Exhaustive test'
    type: boolean
    default: true
  
  - name: proxy_test
  # Proxy tests
    displayName: 'Proxy test'
    type: boolean
    default: true

  - name: msi_test
    # MSI auth based test suites to be run or not
    displayName: 'MSI test'
    type: boolean
    default: true

  - name: healthmon_test
    displayName: 'Healthmon test'
    type: boolean
    default: true

  - name: quick_stress
    displayName: 'Quick Stress'
    type: boolean
    default: true

  - name: verbose_log
    displayName: 'Verbose Log'
    type: boolean
    default: false


stages:
  - ${{ if eq(parameters.base_test, true) }}:
    - stage: BuildAndTest
      jobs:
        # Ubuntu Tests for Block account
        - job: Set_1
          timeoutInMinutes: 300

          strategy:
            matrix:
              Ubuntu-20-BlockBlob:
                AgentName: 'blobfuse-ubuntu20'
                poolName: 'blobfuse-ubuntu-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
                fuselib: 'libfuse-dev'
                tags: 'fuse2'
              Ubuntu-22-BlockBlob:
                AgentName: 'blobfuse-ubuntu22'
                poolName: 'blobfuse-ubuntu-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
                fuselib: 'libfuse3-dev'
                tags: 'fuse3'
              Ubuntu-22-ARM64-BlockBlob:
                AgentName: 'blobfuse-ubn22-arm64'
                poolName: 'blobfuse-ubn-arm64-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22_ARM)
                fuselib: 'libfuse3-dev'
                tags: 'fuse3'

          pool:
            name: $(poolName)
            demands:
              - ImageOverride -equals $(AgentName)

          variables:
            - group: NightlyBlobFuse
            - name: MOUNT_DIR
              value: '$(Pipeline.Workspace)/blob_mnt'
            - name: TEMP_DIR
              value: '$(Pipeline.Workspace)/blobfuse2_tmp'
            - name: BLOBFUSE2_CFG
              value: '$(Pipeline.Workspace)/blobfuse2.yaml'
            - name: BLOBFUSE2_SAS_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_sas_config.yaml'
            - name: BLOBFUSE2_AZCLI_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_azcli_config.yaml'
            - name: BLOBFUSE2_ADLS_CFG
              value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
            - name: BLOBFUSE2_GTEST_CFG
              value: '$(Pipeline.Workspace)/connection.yaml'
            - name: BLOBFUSE2_AZURITE_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_azurite_config.yaml'
            - name: BLOBFUSE2_STRESS_DIR
              value: '$(Pipeline.Workspace)/blobfuse2_stress'
            - name: DECODE_PERCENTS
              value: false
            - name: GOPATH
              value: '$(Pipeline.Workspace)/go'
            - name: ROOT_DIR
              value: '$(System.DefaultWorkingDirectory)' 
            - name: WORK_DIR
              value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

          steps:
            # -------------------------------------------------------
            # Build the code and create the containers.
            - template: 'azure-pipeline-templates/build.yml'
              parameters:
                skip_azcli: "false"

            # -------------------------------------------------------
            - template: 'azure-pipeline-templates/invalid-command-tests.yml'


            - ${{ if eq(parameters.exhaustive_test, true) }}:    
              - template: 'azure-pipeline-templates/verbose-tests.yml'
                parameters:
                  service: 'BlockBlob'
                  account_type: 'block'
                  account_endpoint: 'https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net' 
                  adls: false
                  account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
                  account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
                  account_sas: $(NIGHTLY_STO_ACC_SAS)
                  client_id: $(AZTEST_CLIENT)
                  tenant_id: $(AZTEST_TENANT)
                  client_secret: $(AZTEST_SECRET)
                  config: $(BLOBFUSE2_CFG)
                  stress_dir: $(BLOBFUSE2_STRESS_DIR)
                  huge_container: 'testcnt1'
                  quick_stress: ${{ parameters.quick_stress }}
                  test_key_credential: true 
                  test_sas_credential: true
                  test_azcli_credential: true
                  test_azurite: false
                  sas_credential_config: $(BLOBFUSE2_SAS_CFG)
                  azcli_credential_config: $(BLOBFUSE2_AZCLI_CFG)
                  azurite_config: $(BLOBFUSE2_AZURITE_CFG)
                  distro_name: $(AgentName)
                  verbose_log: ${{ parameters.verbose_log }}

            - template: azure-pipeline-templates/cleanup.yml
              parameters:
                unmount: true
                delete_containers: true

        # Ubuntu Tests for ADLS account
        - job: Set_2
          timeoutInMinutes: 300

          strategy:
            matrix:
              Ubuntu-20-ADLS:
                AgentName: 'blobfuse-ubuntu20'
                poolName: 'blobfuse-ubuntu-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
                fuselib: 'libfuse-dev'
                tags: 'fuse2'
              Ubuntu-22-ADLS:
                AgentName: 'blobfuse-ubuntu22'
                poolName: 'blobfuse-ubuntu-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
                fuselib: 'libfuse3-dev'
                tags: 'fuse3'
              Ubuntu-22-ARM64-ADLS:
                AgentName: 'blobfuse-ubn22-arm64'
                poolName: 'blobfuse-ubn-arm64-pool'
                adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22_ARM)
                fuselib: 'libfuse3-dev'
                tags: 'fuse3'

          pool:
            name: $(poolName)
            demands:
              - ImageOverride -equals $(AgentName)

          variables:
            - group: NightlyBlobFuse
            - name: MOUNT_DIR
              value: '$(Pipeline.Workspace)/blob_mnt'
            - name: TEMP_DIR
              value: '$(Pipeline.Workspace)/blobfuse2_tmp'
            - name: BLOBFUSE2_CFG
              value: '$(Pipeline.Workspace)/blobfuse2.yaml'
            - name: BLOBFUSE2_SAS_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_sas_config.yaml'
            - name: BLOBFUSE2_AZCLI_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_azcli_config.yaml'
            - name: BLOBFUSE2_ADLS_CFG
              value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
            - name: BLOBFUSE2_GTEST_CFG
              value: '$(Pipeline.Workspace)/connection.yaml'
            - name: BLOBFUSE2_AZURITE_CFG
              value: '$(Pipeline.Workspace)/blobfuse2_azurite_config.yaml'
            - name: BLOBFUSE2_STRESS_DIR
              value: '$(Pipeline.Workspace)/blobfuse2_stress'
            - name: DECODE_PERCENTS
              value: false
            - name: GOPATH
              value: '$(Pipeline.Workspace)/go'
            - name: ROOT_DIR
              value: '$(System.DefaultWorkingDirectory)' 
            - name: WORK_DIR
              value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

          steps:
            # -------------------------------------------------------
            # Pull and build the code, Create the Containers in storage account
            - template: 'azure-pipeline-templates/build.yml'
              parameters:
                skip_ut: true # Skip UT because Block Blob set runs it
                skip_azcli: "false"

            # -------------------------------------------------------
            - ${{ if eq(parameters.exhaustive_test, true) }}:    
              - template: 'azure-pipeline-templates/verbose-tests.yml'
                parameters:
                  service: 'ADLS'
                  account_type: 'adls'
                  account_endpoint: 'https://$(AZTEST_ADLS_ACC_NAME).dfs.core.windows.net' 
                  adls: true
                  account_name: $(AZTEST_ADLS_ACC_NAME)
                  account_key: $(AZTEST_ADLS_KEY)
                  account_sas: $(adlsSas)
                  client_id: $(AZTEST_CLIENT)
                  tenant_id: $(AZTEST_TENANT)
                  client_secret: $(AZTEST_SECRET)
                  config: $(BLOBFUSE2_ADLS_CFG)
                  stress_dir: $(BLOBFUSE2_STRESS_DIR)
                  huge_container: 'testcnt'
                  quick_stress: ${{ parameters.quick_stress }}
                  test_key_credential: true
                  test_sas_credential: true
                  test_azcli_credential: true
                  test_azurite: false
                  sas_credential_config: $(BLOBFUSE2_SAS_CFG)
                  azcli_credential_config: $(BLOBFUSE2_AZCLI_CFG)
                  azurite_config: $(BLOBFUSE2_AZURITE_CFG)
                  distro_name: $(AgentName)
                  verbose_log: ${{ parameters.verbose_log }}

            - template: azure-pipeline-templates/cleanup.yml
              parameters:
                unmount: true
                delete_containers: true
                

        - ${{ if eq(parameters.proxy_test, true) }}:
            # -----------------------------------------------------------
            # Ubuntu-20.04 Proxy tests
          - job: Set_3
            timeoutInMinutes: 300
            strategy:
              matrix:
                Ubuntu-20-Proxy:
                  AgentName: 'blobfuse-ubuntu20'

            pool:
              name: "blobfuse-ubuntu-pool"
              demands:
                - ImageOverride -equals $(AgentName)

            variables:
              - group: NightlyBlobFuse
              - name: MOUNT_DIR
                value: '$(Pipeline.Workspace)/blob_mnt'
              - name: TEMP_DIR
                value: '$(Pipeline.Workspace)/blobfuse2_tmp'
              - name: BLOBFUSE2_CFG
                value: '$(Pipeline.Workspace)/blobfuse2_proxy.yaml'
              - name: BLOBFUSE2_ADLS_CFG
                value: '$(Pipeline.Workspace)/blobfuse2_proxy.adls.yaml'
              - name: DECODE_PERCENTS
                value: false
              - name: GOPATH
                value: '$(Pipeline.Workspace)/go'
              - name: ROOT_DIR
                value: '$(System.DefaultWorkingDirectory)' 
              - name: WORK_DIR
                value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

            steps:
              # -------------------------------------------------------
              # Pull, build and unit test the code, create the containers.
              - template: 'azure-pipeline-templates/build.yml'
                parameters:
                  proxy_address: "127.0.0.1:8080"
                  skip_ut: true

              # -------------------------------------------------------
              - script: |
                  cd $(WORK_DIR)
                  $(WORK_DIR)/blobfuse2 gen-test-config --config-file=azure_key_proxy.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=$(BLOBFUSE2_CFG)
                displayName: 'Create Config File'
                env:
                  NIGHTLY_STO_ACC_NAME: $(NIGHTLY_STO_BLOB_ACC_NAME)
                  NIGHTLY_STO_ACC_KEY: $(NIGHTLY_STO_BLOB_ACC_KEY)
                  ACCOUNT_TYPE: 'block'
                  ACCOUNT_ENDPOINT: 'https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net'
                  VERBOSE_LOG: ${{ parameters.verbose_log }}
                continueOnError: false

              - script:
                  cat $(BLOBFUSE2_CFG)
                displayName: "Print config file"

              # --------------------------------------------------
              # End to End tests
              - template: 'azure-pipeline-templates/e2e-tests.yml'
                parameters:
                  working_dir: $(WORK_DIR)
                  mount_dir: $(MOUNT_DIR)
                  temp_dir: $(TEMP_DIR)
                  idstring: 'BlockBlob with Proxy and Key Credentials'
                  distro_name: $(AgentName)
                  adls: false
                  artifact_name: 'blockblob_proxy_key.txt'
                  verbose_log: ${{ parameters.verbose_log }}
                  mountStep:
                    script: |
                      $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=$(BLOBFUSE2_CFG) --default-working-dir=$(WORK_DIR)
                    displayName: 'E2E TEST: Mount'
                    timeoutInMinutes: 3
                    continueOnError: false

              # --------------------------------------------------
              - script: |
                  cd $(WORK_DIR)
                  $(WORK_DIR)/blobfuse2 gen-test-config --config-file=azure_key_proxy.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=$(BLOBFUSE2_ADLS_CFG)
                displayName: 'Create ADLS Config File'
                env:
                  NIGHTLY_STO_ACC_NAME: $(AZTEST_ADLS_ACC_NAME)
                  NIGHTLY_STO_ACC_KEY: $(AZTEST_ADLS_KEY)
                  ACCOUNT_TYPE: 'adls'
                  ACCOUNT_ENDPOINT: 'https://$(AZTEST_ADLS_ACC_NAME).dfs.core.windows.net'
                  VERBOSE_LOG: ${{ parameters.verbose_log }}
                continueOnError: false

              - script:
                  cat $(BLOBFUSE2_ADLS_CFG)
                displayName: "Print ADLS config file"

              - template: 'azure-pipeline-templates/e2e-tests.yml'
                parameters:
                  working_dir: $(WORK_DIR)
                  mount_dir: $(MOUNT_DIR)
                  temp_dir: $(TEMP_DIR)
                  idstring: 'ADLS with Proxy and Key Credentials'
                  distro_name: $(AgentName)
                  adls: true
                  artifact_name: 'adls_proxy_key.txt'
                  verbose_log: ${{ parameters.verbose_log }}
                  mountStep:
                    script: |
                      $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=$(BLOBFUSE2_ADLS_CFG) --default-working-dir=$(WORK_DIR)
                    displayName: 'FeatureTest ADLS: Mount'
                    timeoutInMinutes: 3
                    continueOnError: false
              # ------------------------------------------------------------
              # Auth Tests
            
              # Block SAS test
              - script: |
                  cd $(WORK_DIR)
                  $(WORK_DIR)/blobfuse2 gen-test-config --config-file=azure_sas_proxy.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=$(BLOBFUSE2_CFG)
                displayName: "Create SAS Config File"
                env:
                  NIGHTLY_STO_BLOB_ACC_NAME: $(NIGHTLY_STO_BLOB_ACC_NAME)
                  NIGHTLY_STO_ACC_SAS: $(NIGHTLY_STO_ACC_SAS)
                  ACCOUNT_ENDPOINT: 'https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net'
                  VERBOSE_LOG: ${{ parameters.verbose_log }}
                continueOnError: false

              - script:
                  cat $(BLOBFUSE2_CFG)
                displayName: "Print SAS config file"

              - template: 'azure-pipeline-templates/verify-auth.yml'
                parameters:
                  working_dir: $(WORK_DIR)
                  mount_dir: $(MOUNT_DIR)
                  temp_dir: $(TEMP_DIR)
                  idstring: 'Block SAS'
                  distro_name: $(AgentName)
                  mountStep:
                    script: |
                      $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=$(BLOBFUSE2_CFG) --default-working-dir=$(WORK_DIR)
                    displayName: 'AuthVerify-SAS: Mount'
                    continueOnError: false

              # ------------------------------------------------------------
              - template: 'azure-pipeline-templates/cleanup.yml'
                parameters:
                  unmount: true
                  delete_containers: true                  
              - script: |
                  kill -9 $(pgrep mitmdump)
                displayName: 'Kill Proxy'
        - ${{ if eq(parameters.msi_test, true) }}:  
          # -----------------------------------------------------------
          # Ubuntu-20.04 MSI tests
          - job: Set_4
            timeoutInMinutes: 60
            strategy:
              matrix:
                Ubuntu-20-MSI:
                  DistroVer: "Ubn20_MSI"
                  AgentName: "blobfuse-ubuntu20"
                  Description: "Ubuntu 20 MSI Test"

            pool:
              name: "blobfuse-ubuntu-pool"
              demands:
                - ImageOverride -equals $(AgentName)

            variables:
              - group: NightlyBlobFuse
              - name: MOUNT_DIR
                value: '$(Pipeline.Workspace)/blob_mnt'
              - name: TEMP_DIR
                value: '$(Pipeline.Workspace)/blobfuse2_tmp'
              - name: BLOBFUSE2_CFG
                value: '$(Pipeline.Workspace)/blobfuse2.msi.yaml'
              - name: BLOBFUSE2_ADLS_CFG
                value: '$(Pipeline.Workspace)/blobfuse2.msi.adls.yaml'
              - name: GOPATH
                value: '$(Pipeline.Workspace)/go'
              - name: ROOT_DIR
                value: '$(System.DefaultWorkingDirectory)' 
              - name: WORK_DIR
                value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'
              - name: skipComponentGovernanceDetection
                value: true

            steps:
              # Print the agent info 
              - script: |
                  echo $(Description)
                  hostnamectl
                displayName: 'Print Agent Info'

              # Build the code
              - template: 'azure-pipeline-templates/build.yml'
                parameters:
                  skip_msi: "false"
                  skip_azcli: "false"

              # BlockBlob MSI Test
              - script: |
                  cd $(WORK_DIR)
                  $(WORK_DIR)/blobfuse2 gen-test-config --config-file=azure_msi.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=$(BLOBFUSE2_CFG)
                displayName: "Create MSI Config File"
                env:
                  NIGHTLY_STO_BLOB_ACC_NAME: $(AZTEST_BLOCK_ACC_NAME) 
                  NIGHTLY_MSI_APP_ID: $(AZTEST_APP_ID)
                  ACCOUNT_TYPE: 'block'
                  ACCOUNT_ENDPOINT: 'https://$(AZTEST_BLOCK_ACC_NAME).blob.core.windows.net'
                  VERBOSE_LOG: ${{ parameters.verbose_log }}
                continueOnError: false

              - script:
                  cat $(BLOBFUSE2_CFG)
                displayName: "Print config file"

              # Mount the container and run basic tests
              - template: 'azure-pipeline-templates/verify-auth.yml'
                parameters:
                  idstring: 'BlockBlob MSI'
                  distro_name: $(AgentName)
                  mountStep:
                    script: |
                      $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=$(BLOBFUSE2_CFG)
                    displayName: 'AuthVerify MSI: Mount Container'
                    continueOnError: false

              # ADLS MSI Test
              - script: |
                  cd $(WORK_DIR)
                  $(WORK_DIR)/blobfuse2 gen-test-config --config-file=azure_msi.yaml --container-name=$(containerName) --temp-path=$(TEMP_DIR) --output-file=$(BLOBFUSE2_CFG)
                displayName: "Create MSI Config File"
                env:
                  NIGHTLY_STO_BLOB_ACC_NAME: $(AZTEST_ADLS_ACC_NAME) 
                  NIGHTLY_MSI_APP_ID: $(AZTEST_APP_ID)
                  ACCOUNT_TYPE: 'adls'
                  ACCOUNT_ENDPOINT: 'https://$(AZTEST_ADLS_ACC_NAME).dfs.core.windows.net'
                  VERBOSE_LOG: ${{ parameters.verbose_log }}
                continueOnError: false

              - script:
                  cat $(BLOBFUSE2_CFG)
                displayName: "Print config file"

              # Mount the cntainer and run basic tests
              - template: 'azure-pipeline-templates/verify-auth.yml'
                parameters:
                  idstring: 'ADLS MSI'
                  distro_name: $(AgentName)
                  mountStep:
                    script: |
                      $(WORK_DIR)/blobfuse2 mount $(MOUNT_DIR) --config-file=$(BLOBFUSE2_CFG)
                    displayName: 'AuthVerify MSI: Mount Container'
                    continueOnError: false

              # Cleanup
              - template: 'azure-pipeline-templates/cleanup.yml'
                parameters:
                  unmount: true
                  delete_containers: true            

        
        - ${{ if eq(parameters.exhaustive_test, true) }}:
          # Run E2E tests on different distros
          - job: Set_5
            continueOnError: true
            timeoutInMinutes: 60
            strategy:
              matrix:
                RHEL-8.6:
                  DistroVer: 'RHEL-8.6'
                  distroId: '1'
                  poolName: 'blobfuse-rhel-pool'
                  Description: 'Red Hat Enterprise Linux 8.6'
                  AgentName: 'blobfuse-rhel8_6'
                  tags: 'fuse3'
                RHEL-9.0:
                  DistroVer: 'RHEL-9.0'
                  distroId: '1'
                  poolName: 'blobfuse-rhel-pool'
                  Description: 'Red Hat Enterprise Linux 9.0'
                  AgentName: 'blobfuse-rhel9'
                  tags: 'fuse3'
                CentOS-7.9:
                  DistroVer: "CentOS-7.9"
                  distroId: '2'
                  poolName: 'blobfuse-centos-pool'
                  Description: "CentOS 7.9"
                  AgentName: "blobfuse-centos7"
                CentOS-8.5:
                  DistroVer: "CentOS-8.5"
                  distroId: '2'
                  poolName: 'blobfuse-centos-pool'
                  Description: "CentOS 8.5"
                  AgentName: "blobfuse-centos8"
                Oracle-8.1:
                  DistroVer: "Oracle-8.1"
                  distroId: '3'
                  poolName: 'blobfuse-oracle-pool'
                  Description: "Oracle Linux 8.1"
                  AgentName: "blobfuse-oracle81"
                Rocky-8.0:
                  DistroVer: "Rocky-8.0"
                  distroId: '4'
                  poolName: 'blobfuse2-rocky-pool'
                  Description: "Rocky Linux 8.0"
                  AgentName: "blobfuse-rocky8"
                  tags: 'fuse3'
                Rocky-9.0:
                  DistroVer: "Rocky-9.0"
                  distroId: '4'
                  poolName: 'blobfuse2-rocky-pool'
                  Description: "Rocky Linux 9.0"
                  AgentName: "blobfuse-rocky9"
                  tags: 'fuse3'
                SUSE-15:
                  DistroVer: "SUSE-15"
                  distroId: '5'
                  poolName: 'blobfuse-suse-pool'
                  Description: "SUSE Enterprise Linux 15"
                  AgentName: "blobfuse-suse15"
                Mariner2:
                  DistroVer: "Mariner2"
                  distroId: '6'
                  poolName: 'blobfuse-mariner-pool'
                  Description: "CBL-Mariner2 Linux"
                  AgentName: "blobfuse-mariner2"
                  fuselib: 'libfuse3-dev'
                  tags: 'fuse3'                  
            pool:
              name: $(poolName)
              demands:
                - ImageOverride -equals $(AgentName)

            variables:
              - group: NightlyBlobFuse
              - name: MOUNT_DIR
                value: '$(Pipeline.Workspace)/blob_mnt'
              - name: TEMP_DIR
                value: '$(Pipeline.Workspace)/blobfuse2_tmp'
              - name: BLOBFUSE2_CFG
                value: '$(Pipeline.Workspace)/blobfuse2.yaml'
              - name: BLOBFUSE2_ADLS_CFG
                value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
              - name: GOPATH
                value: '$(Pipeline.Workspace)/go'
              - name: ROOT_DIR
                value: '$(System.DefaultWorkingDirectory)' 
              - name: WORK_DIR
                value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'
              - name: skipComponentGovernanceDetection
                value: true

            steps:
              - template: 'azure-pipeline-templates/distro-tests.yml'
                parameters:
                  working_dir: $(WORK_DIR)
                  root_dir: $(ROOT_DIR)
                  temp_dir: $(TEMP_DIR)
                  mount_dir: $(MOUNT_DIR)
                  config_path: $(BLOBFUSE2_CFG)
                  container: $(ContainerName)
                  blob_account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
                  blob_account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
                  adls_account_name: $(AZTEST_ADLS_ACC_NAME)
                  adls_account_key: $(AZTEST_ADLS_KEY)
                  distro_name: $(AgentName)
                  gopath: $(GOPATH)
                  tags: $(tags) 
                  verbose_log: ${{ parameters.verbose_log }}

  - stage: BlockCacheDataValidation
    jobs:
      # Ubuntu Tests
      - job: Set_1
        timeoutInMinutes: 300
        strategy:
          matrix:
            Ubuntu-22:
              AgentName: 'blobfuse-ubuntu22'
              containerName: 'test-cnt-ubn-22'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
              fuselib: 'libfuse3-dev'
              tags: 'fuse3'
            Ubuntu-20:
              AgentName: 'blobfuse-ubuntu20'
              containerName: 'test-cnt-ubn-20'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
              fuselib: 'libfuse-dev'
              tags: 'fuse2'

        pool:
          name: "blobfuse-ubuntu-pool"
          demands:
            - ImageOverride -equals $(AgentName)

        variables:
          - group: NightlyBlobFuse
          - name: MOUNT_DIR
            value: '$(Pipeline.Workspace)/blob_mnt'
          - name: TEMP_DIR
            value: '$(Pipeline.Workspace)/blobfuse2_tmp'
          - name: BLOBFUSE2_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.yaml'
          - name: BLOBFUSE2_ADLS_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
          - name: skipComponentGovernanceDetection
            value: true
          - name: GOPATH
            value: '$(Pipeline.Workspace)/go'
          - name: ROOT_DIR
            value: '$(System.DefaultWorkingDirectory)' 
          - name: WORK_DIR
            value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

        steps:
          # -------------------------------------------------------
          # Pull and build the code
          - template: 'azure-pipeline-templates/build.yml'
            parameters:
              working_directory: $(WORK_DIR)
              root_dir: $(ROOT_DIR)
              mount_dir: $(MOUNT_DIR)
              temp_dir: $(TEMP_DIR)
              gopath: $(GOPATH)
              container: $(containerName)
              tags: $(tags)
              fuselib: $(fuselib)
              skip_ut: true

          - template: 'azure-pipeline-templates/e2e-tests-block-cache.yml'
            parameters:
              conf_template: azure_key.yaml
              config_file: $(BLOBFUSE2_CFG)
              container: $(containerName)
              idstring: Block_Blob
              adls: false
              account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
              account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
              account_type: block
              account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
              distro_name: $(AgentName)
              quick_test: false
              verbose_log: ${{ parameters.verbose_log }}
              clone: true
              # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
              temp_dir: $(TEMP_DIR)
              mount_dir: $(MOUNT_DIR)
  
  - stage: BlockCacheDataDirectIOValidation
    jobs:
      # Ubuntu Tests
      - job: Set_1
        timeoutInMinutes: 300
        strategy:
          matrix:
            Ubuntu-20:
              AgentName: 'blobfuse-ubuntu20'
              containerName: 'test-cnt-ubn-20'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
              fuselib: 'libfuse-dev'
              tags: 'fuse2'          
            Ubuntu-22:
              AgentName: 'blobfuse-ubuntu22'
              containerName: 'test-cnt-ubn-22'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
              fuselib: 'libfuse3-dev'
              tags: 'fuse3'

        pool:
          name: "blobfuse-ubuntu-pool"
          demands:
            - ImageOverride -equals $(AgentName)
    
        variables:
          - group: NightlyBlobFuse
          - name: MOUNT_DIR
            value: '$(Pipeline.Workspace)/blob_mnt'
          - name: TEMP_DIR
            value: '$(Pipeline.Workspace)/blobfuse2_tmp'
          - name: BLOBFUSE2_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.yaml'
          - name: BLOBFUSE2_ADLS_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
          - name: skipComponentGovernanceDetection
            value: true
          - name: GOPATH
            value: '$(Pipeline.Workspace)/go'
          - name: ROOT_DIR
            value: '$(System.DefaultWorkingDirectory)' 
          - name: WORK_DIR
            value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

        steps:
          # -------------------------------------------------------
          # Pull and build the code
          - template: 'azure-pipeline-templates/build.yml'
            parameters:
              working_directory: $(WORK_DIR)
              root_dir: $(ROOT_DIR)
              mount_dir: $(MOUNT_DIR)
              temp_dir: $(TEMP_DIR)
              gopath: $(GOPATH)
              container: $(containerName)
              tags: $(tags)
              fuselib: $(fuselib)
              skip_ut: true

          - template: 'azure-pipeline-templates/e2e-tests-block-cache.yml'
            parameters:
              conf_template: azure_key.yaml
              config_file: $(BLOBFUSE2_CFG)
              container: $(containerName)
              idstring: Block_Blob
              adls: false
              account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
              account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
              account_type: block
              account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
              distro_name: $(AgentName)
              quick_test: false
              verbose_log: ${{ parameters.verbose_log }}
              clone: true
              # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
              temp_dir: $(TEMP_DIR)
              mount_dir: $(MOUNT_DIR)
              mnt_flags: "-o direct_io"


  - stage: BlockCacheDataIntegrityValidation
    jobs:
      # Ubuntu Tests
      - job: Set_1
        timeoutInMinutes: 300
        strategy:
          matrix:
            Ubuntu-20:
              AgentName: 'blobfuse-ubuntu20'
              containerName: 'test-cnt-ubn-20'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
              fuselib: 'libfuse-dev'
              tags: 'fuse2'          
            Ubuntu-22:
              AgentName: 'blobfuse-ubuntu22'
              containerName: 'test-cnt-ubn-22'
              adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
              fuselib: 'libfuse3-dev'
              tags: 'fuse3'

        pool:
          name: "blobfuse-ubuntu-pool"
          demands:
            - ImageOverride -equals $(AgentName)

        variables:
          - group: NightlyBlobFuse
          - name: MOUNT_DIR
            value: '$(Pipeline.Workspace)/blob_mnt'
          - name: TEMP_DIR
            value: '$(Pipeline.Workspace)/blobfuse2_tmp'
          - name: BLOBFUSE2_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.yaml'
          - name: BLOBFUSE2_ADLS_CFG
            value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
          - name: skipComponentGovernanceDetection
            value: true
          - name: GOPATH
            value: '$(Pipeline.Workspace)/go'
          - name: ROOT_DIR
            value: '$(System.DefaultWorkingDirectory)' 
          - name: WORK_DIR
            value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

        steps:
          # -------------------------------------------------------
          # Pull and build the code
          - template: 'azure-pipeline-templates/build.yml'
            parameters:
              working_directory: $(WORK_DIR)
              root_dir: $(ROOT_DIR)
              mount_dir: $(MOUNT_DIR)
              temp_dir: $(TEMP_DIR)
              gopath: $(GOPATH)
              container: $(containerName)
              tags: $(tags)
              fuselib: $(fuselib)
              skip_ut: true

          - script: |
              sudo apt-get install python3-setuptools -y
              sudo apt install python3-pip -y
              sudo pip3 install pandas numpy pyarrow fastparquet
            displayName: 'Install Python Packages'

          - template: 'azure-pipeline-templates/e2e-tests-block-cache-data-integrity.yml'
            parameters:
              conf_template: azure_key.yaml
              config_file: $(BLOBFUSE2_CFG)
              container: $(containerName)
              idstring: Block_Blob
              adls: false
              account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
              account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
              account_type: block
              account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
              distro_name: $(AgentName)
              quick_test: false
              verbose_log: ${{ parameters.verbose_log }}
              clone: true
              # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
              temp_dir: $(TEMP_DIR)
              mount_dir: $(MOUNT_DIR)
              block_size_mb: "1"

          - template: 'azure-pipeline-templates/e2e-tests-block-cache-data-integrity.yml'
            parameters:
              conf_template: azure_key.yaml
              config_file: $(BLOBFUSE2_CFG)
              container: $(containerName)
              idstring: Block_Blob
              adls: false
              account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
              account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
              account_type: block
              account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
              distro_name: $(AgentName)
              quick_test: false
              verbose_log: ${{ parameters.verbose_log }}
              clone: true
              # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
              temp_dir: $(TEMP_DIR)
              mount_dir: $(MOUNT_DIR)
              block_size_mb: "8"


# Run e2e tests for file cache, stream on hns, fns


  # - stage: StreamDataValidation
  #   jobs:
  #     # Ubuntu Tests
  #     - job: Set_1
  #       timeoutInMinutes: 300
  #       strategy:
  #         matrix:
  #           Ubuntu-22:
  #             AgentName: 'blobfuse-ubuntu22'
  #             containerName: 'test-cnt-ubn-22'
  #             adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
  #             fuselib: 'libfuse3-dev'
  #             tags: 'fuse3'

  #       pool:
  #         name: "blobfuse-ubuntu-pool"
  #         demands:
  #           - ImageOverride -equals $(AgentName)

  #       variables:
  #         - group: NightlyBlobFuse
  #         - name: MOUNT_DIR
  #           value: '$(Pipeline.Workspace)/blob_mnt'
  #         - name: TEMP_DIR
  #           value: '$(Pipeline.Workspace)/blobfuse2_tmp'
  #         - name: BLOBFUSE2_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.yaml'
  #         - name: BLOBFUSE2_ADLS_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
  #         - name: skipComponentGovernanceDetection
  #           value: true
  #         - name: GOPATH
  #           value: '$(Pipeline.Workspace)/go'
  #         - name: ROOT_DIR
  #           value: '$(System.DefaultWorkingDirectory)' 
  #         - name: WORK_DIR
  #           value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

  #       steps:
  #         # -------------------------------------------------------
  #         # Pull and build the code
  #         - template: 'azure-pipeline-templates/build.yml'
  #           parameters:
  #             working_directory: $(WORK_DIR)
  #             root_dir: $(ROOT_DIR)
  #             mount_dir: $(MOUNT_DIR)
  #             temp_dir: $(TEMP_DIR)
  #             gopath: $(GOPATH)
  #             container: $(containerName)
  #             tags: $(tags)
  #             fuselib: $(fuselib)
  #             skip_ut: true

  #         - template: 'azure-pipeline-templates/e2e-tests-block-cache.yml'
  #           parameters:
  #             conf_template: azure_stream.yaml
  #             config_file: $(BLOBFUSE2_CFG)
  #             container: $(containerName)
  #             idstring: Stream
  #             adls: false
  #             account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
  #             account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
  #             account_type: block
  #             account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
  #             distro_name: $(AgentName)
  #             quick_test: false
  #             verbose_log: ${{ parameters.verbose_log }}
  #             clone: true
  #             # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
  #             temp_dir: $(TEMP_DIR)
  #             mount_dir: $(MOUNT_DIR)

  # - stage: FNSDataValidation
  #   jobs:
  #     # Ubuntu Tests
  #     - job: Set_1
  #       timeoutInMinutes: 300
  #       strategy:
  #         matrix:
  #           Ubuntu-20:
  #             AgentName: 'blobfuse-ubuntu20'
  #             containerName: 'test-cnt-ubn-20'
  #             adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
  #             fuselib: 'libfuse-dev'
  #             tags: 'fuse2'
  #           Ubuntu-22:
  #             AgentName: 'blobfuse-ubuntu22'
  #             containerName: 'test-cnt-ubn-22'
  #             adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
  #             fuselib: 'libfuse3-dev'
  #             tags: 'fuse3'

  #       pool:
  #         name: "blobfuse-ubuntu-pool"
  #         demands:
  #           - ImageOverride -equals $(AgentName)

  #       variables:
  #         - group: NightlyBlobFuse
  #         - name: MOUNT_DIR
  #           value: '$(Pipeline.Workspace)/blob_mnt'
  #         - name: TEMP_DIR
  #           value: '$(Pipeline.Workspace)/blobfuse2_tmp'
  #         - name: BLOBFUSE2_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.yaml'
  #         - name: BLOBFUSE2_ADLS_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
  #         - name: skipComponentGovernanceDetection
  #           value: true
  #         - name: GOPATH
  #           value: '$(Pipeline.Workspace)/go'
  #         - name: ROOT_DIR
  #           value: '$(System.DefaultWorkingDirectory)' 
  #         - name: WORK_DIR
  #           value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

  #       steps:
  #         # -------------------------------------------------------
  #         # Pull and build the code
  #         - template: 'azure-pipeline-templates/build.yml'
  #           parameters:
  #             working_directory: $(WORK_DIR)
  #             root_dir: $(ROOT_DIR)
  #             mount_dir: $(MOUNT_DIR)
  #             temp_dir: $(TEMP_DIR)
  #             gopath: $(GOPATH)
  #             container: $(containerName)
  #             tags: $(tags)
  #             fuselib: $(fuselib)
  #             skip_ut: true

  #         - template: 'azure-pipeline-templates/e2e-tests-spcl.yml'
  #           parameters:
  #             conf_template: azure_key.yaml
  #             config_file: $(BLOBFUSE2_CFG)
  #             container: $(containerName)
  #             idstring: Block_Blob
  #             adls: false
  #             account_name: $(NIGHTLY_STO_BLOB_ACC_NAME)
  #             account_key: $(NIGHTLY_STO_BLOB_ACC_KEY)
  #             account_type: block
  #             account_endpoint: https://$(NIGHTLY_STO_BLOB_ACC_NAME).blob.core.windows.net
  #             distro_name: $(AgentName)
  #             quick_test: false
  #             verbose_log: ${{ parameters.verbose_log }}
  #             clone: true
  #             # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
  #             temp_dir: $(TEMP_DIR)
  #             mount_dir: $(MOUNT_DIR)

  # - stage: HNSDataValidation
  #   jobs:
  #     # Ubuntu Tests
  #     - job: Set_1
  #       timeoutInMinutes: 300
  #       strategy:
  #         matrix:
  #           Ubuntu-20:
  #             AgentName: 'blobfuse-ubuntu20'
  #             containerName: 'test-cnt-ubn-20'
  #             adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_20)
  #             fuselib: 'libfuse-dev'
  #             tags: 'fuse2'
  #           Ubuntu-22:
  #             AgentName: 'blobfuse-ubuntu22'
  #             containerName: 'test-cnt-ubn-22'
  #             adlsSas: $(AZTEST_ADLS_CONT_SAS_UBN_22)
  #             fuselib: 'libfuse3-dev'
  #             tags: 'fuse3'

  #       pool:
  #         name: "blobfuse-ubuntu-pool"
  #         demands:
  #           - ImageOverride -equals $(AgentName)

  #       variables:
  #         - group: NightlyBlobFuse
  #         - name: MOUNT_DIR
  #           value: '$(Pipeline.Workspace)/blob_mnt'
  #         - name: TEMP_DIR
  #           value: '$(Pipeline.Workspace)/blobfuse2_tmp'
  #         - name: BLOBFUSE2_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.yaml'
  #         - name: BLOBFUSE2_ADLS_CFG
  #           value: '$(Pipeline.Workspace)/blobfuse2.adls.yaml'
  #         - name: skipComponentGovernanceDetection
  #           value: true
  #         - name: GOPATH
  #           value: '$(Pipeline.Workspace)/go'
  #         - name: ROOT_DIR
  #           value: '$(System.DefaultWorkingDirectory)' 
  #         - name: WORK_DIR
  #           value: '$(System.DefaultWorkingDirectory)/azure-storage-fuse'

  #       steps:
  #         # -------------------------------------------------------
  #         # Pull and build the code
  #         - template: 'azure-pipeline-templates/build.yml'
  #           parameters:
  #             working_directory: $(WORK_DIR)
  #             root_dir: $(ROOT_DIR)
  #             mount_dir: $(MOUNT_DIR)
  #             temp_dir: $(TEMP_DIR)
  #             gopath: $(GOPATH)
  #             container: $(containerName)
  #             tags: $(tags)
  #             fuselib: $(fuselib)
  #             skip_ut: true

  #         - template: 'azure-pipeline-templates/e2e-tests-spcl.yml'
  #           parameters:
  #             conf_template: azure_key.yaml
  #             config_file: $(BLOBFUSE2_CFG)
  #             container: $(containerName)
  #             idstring: ADLS
  #             adls: true
  #             account_name: $(AZTEST_ADLS_ACC_NAME)
  #             account_key: $(AZTEST_ADLS_KEY)
  #             account_type: adls
  #             account_endpoint: https://$(AZTEST_ADLS_ACC_NAME).dfs.core.windows.net
  #             distro_name: $(AgentName)
  #             quick_test: false
  #             verbose_log: ${{ parameters.verbose_log }}
  #             clone: true
  #             # TODO: These can be removed one day and replace all instances of ${{ parameters.temp_dir }} with $(TEMP_DIR) since it is a global variable
  #             temp_dir: $(TEMP_DIR)
  #             mount_dir: $(MOUNT_DIR)
